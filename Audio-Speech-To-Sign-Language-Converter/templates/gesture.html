{% extends 'base.html' %}
{% load static %}

{% block title %}Gesture to Text - ISL Translator{% endblock %}

{% block extra_head %}
<style>
    .gesture-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
    }

    @media (max-width: 900px) {
        .gesture-container {
            grid-template-columns: 1fr;
        }
    }

    .video-panel {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 4/3;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #video-feed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .status-panel {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .prediction-card {
        text-align: center;
        padding: 20px;
        background: rgba(56, 189, 248, 0.1);
        border-radius: 15px;
        border: 1px solid var(--accent-color);
    }

    .prediction-char {
        font-size: 4rem;
        font-weight: 800;
        color: var(--accent-color);
        margin: 10px 0;
    }

    .sentence-display {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        min-height: 100px;
        font-size: 1.2rem;
        word-wrap: break-word;
    }

    .controls-row {
        display: flex;
        gap: 10px;
    }

    .btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
        text-align: center;
    }

    .btn-clear {
        background: #ef4444;
        color: white;
    }

    .btn-clear:hover {
        background: #dc2626;
    }

    .btn-speak {
        background: #a855f7;
        color: white;
    }

    .btn-speak:hover {
        background: #9333ea;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        gap: 15px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="gesture-container">
    <div class="video-panel">
        <video id="video-feed" autoplay playsinline muted></video>
        <div id="loading-overlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Initializing Camera...</p>
        </div>
        <canvas id="capture-canvas" style="display:none;"></canvas>
    </div>

    <div class="status-panel">
        <div class="prediction-card">
            <h3>Predicted Character</h3>
            <div id="predicted-char" class="prediction-char">-</div>
        </div>

        <div>
            <h3>Sentence</h3>
            <div id="sentence-display" class="sentence-display"></div>
        </div>

        <div class="controls-row">
            <button id="clear-btn" class="btn btn-clear">CLEAR</button>
            <button id="speak-btn" class="btn btn-speak">SPEAK</button>
        </div>

        <div style="font-size: 0.8rem; opacity: 0.6;">
            <p><i class="fas fa-info-circle"></i> Tips:</p>
            <ul>
                <li>Hold gesture steady for a moment</li>
                <li>Ensure good lighting</li>
                <li>Character is added when it changes</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('capture-canvas');
    const charDisplay = document.getElementById('predicted-char');
    const sentenceDisplay = document.getElementById('sentence-display');
    const loadingOverlay = document.getElementById('loading-overlay');
    const clearBtn = document.getElementById('clear-btn');
    const speakBtn = document.getElementById('speak-btn');

    let currentSentence = "";
    let lastChar = "";
    let isProcessing = false;

    // Camera setup
    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 }
            });
            video.srcObject = stream;
            loadingOverlay.style.display = 'none';

            // Start processing loop
            setInterval(captureAndPredict, 500); // 2 FPS to allow backend processing
        } catch (err) {
            console.error("Camera error:", err);
            loadingOverlay.innerHTML = "<p style='color:#ef4444'>Camera Access Denied</p>";
        }
    }

    async function captureAndPredict() {
        if (isProcessing) return;
        isProcessing = true;

        const context = canvas.getContext('2d');
        canvas.width = 640;
        canvas.height = 480;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/jpeg', 0.8);

        try {
            const response = await fetch('/ajax_predict/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();
            if (data.prediction && data.prediction !== "-") {
                const char = data.prediction;
                charDisplay.innerText = char;

                // Threshold logic for adding to sentence
                if (char !== lastChar && char !== "next") {
                    currentSentence += char;
                    sentenceDisplay.innerText = currentSentence;
                    lastChar = char;
                } else if (char === "next") {
                    // Space logic
                    if (!currentSentence.endsWith(" ")) {
                        currentSentence += " ";
                        sentenceDisplay.innerText = currentSentence;
                    }
                }
            }
        } catch (err) {
            console.error("Prediction error:", err);
        } finally {
            isProcessing = false;
        }
    }

    clearBtn.addEventListener('click', () => {
        currentSentence = "";
        sentenceDisplay.innerText = "";
        lastChar = "";
        charDisplay.innerText = "-";
    });

    speakBtn.addEventListener('click', () => {
        if (currentSentence) {
            const utterance = new SpeechSynthesisUtterance(currentSentence);
            window.speechSynthesis.speak(utterance);
        }
    });

    // Handle Navbar Active State (fix for base.html active highlight)
    document.getElementById('nav-gesture')?.classList.add('active');
    document.getElementById('nav-home')?.classList.remove('active');

    setupCamera();
</script>
{% endblock %}